<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mu Niu, Yixin Xue, Amber Wang, David Lin, Qifei Cui">
<meta name="dcterms.date" content="2023-12-13">

<title>XGBoost Vignette: Fraud Detection</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="vignette_files/libs/clipboard/clipboard.min.js"></script>
<script src="vignette_files/libs/quarto-html/quarto.js"></script>
<script src="vignette_files/libs/quarto-html/popper.min.js"></script>
<script src="vignette_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="vignette_files/libs/quarto-html/anchor.min.js"></script>
<link href="vignette_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="vignette_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="vignette_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="vignette_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="vignette_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">XGBoost Vignette: Fraud Detection</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Mu Niu, Yixin Xue, Amber Wang, David Lin, Qifei Cui </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 13, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="objectives" class="level4">
<h4 class="anchored" data-anchor-id="objectives">Objectives</h4>
<p>In this vignette, you will embark on an in-depth exploration, starting from the foundational theory of XGBoost to its practical application such as Exploratory Data Analysis(EDA) and XGBoost model training. This journey will lead you to effectively utilize XGBoost, which is a cutting-edge and industry-standard model. You’ll develop skills in:</p>
<ul>
<li><p>Utilizing functions from the <strong>ggplot</strong> and <strong>corrplot</strong> packages for EDA and data visualization. These tools are essential for understanding the underlying patterns and relationships in your data.</p></li>
<li><p>Employing functions from the <strong>xgboost</strong> package to train an Extreme Gradient Boosting Model. This powerful machine learning technique is renowned for its efficiency and effectiveness in various predictive modeling tasks.</p></li>
<li><p>Leveraging functions from the <strong>pROC</strong> package to evaluate the performance of your model. This is crucial for assessing the effectiveness of your predictive model in real-world scenarios.</p></li>
</ul>
<p>By the end of this vignette, you will have a solid understanding of how to effectively use these tools in a cohesive workflow to build and assess a robust machine learning model.</p>
</section>
<section id="prerequisites" class="level4">
<h4 class="anchored" data-anchor-id="prerequisites">Prerequisites</h4>
<p>First, please follow the action item below to get set up for the vignette. You may need to install one or more packages if the library() calls return an error.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xgboost)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pROC)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrplot)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># read data</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/card_transdata.csv"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>XGBoost, an acronym for eXtreme Gradient Boosting, was crafted by Dr.&nbsp;Tianqi Chen in 2016 as a gradient-boosting algorithm. Demonstrating remarkable success, it has emerged as a formidable player in various data science competitions. Renowned for its exceptional performance, XGBoost stands out as a robust solution for tasks such as handling structured data, text classification, regression, and notably, exhibiting superior capabilities on large-scale datasets. Our vignette presents a comprehensive exploration of XGBoost, including its mathematical principles, programming language support, and practical application in classification problems.</p>
</section>
<section id="principal-and-theory" class="level2">
<h2 class="anchored" data-anchor-id="principal-and-theory">Principal and Theory</h2>
<p>Prior to implementing the XGBoost model on the dataset, it is crucial to first understand the underlying mathematical principles of the Boosted Trees and XGBoost</p>
<p><strong>Gradient Boosted Decision Tree (GBDT)</strong></p>
<p>In GBDT, the prediction of observation i is the sum of the predicted values from each of the k trees in the ensemble.</p>
<p><span class="math display">\[\hat{y} = \sum_{i=1}^{k} f_k(x_i)\]</span>Each tree in the boosting model fits the negative gradient of the loss function to the current model’s prediction, and the current model’s prediction is the sum of the first k-1 trees.</p>
<p>If we use mean squared error as the loss function in a regression task, each tree simply fits the residual.</p>
<p>For example, suppose a person is 30 years old, and a GBDT model is used to predict his age.</p>
<ul>
<li><p>Given the dataset, suppose the first tree’s prediction is 20.</p></li>
<li><p>Then the second tree fits the residual, which is 30 - 20 = 10. Suppose the second tree outputs 7.</p></li>
<li><p>Then the third tree fits the residual 10 - 7 = 3. Suppose the third tree outputs 2.</p></li>
<li><p>By adding the prediction of the three trees, we get our final prediction.</p></li>
</ul>
<p><strong>XGBoost</strong></p>
<p>XGBoost is an efficient and scalable implementation of the gradient-boosted decision tree.</p>
<ul>
<li>Tree Boosting</li>
</ul>
<p>The objective function for k-th tree is <span class="math display">\[\sum_{i=1}^{n} l(y_i, \hat{y_i}^{(k)})+\sum_{i=1}^{K}\omega(f_i)\]</span></p>
<p>The first term in the objective function denotes the loss function. It can be MSE in regression or cross-entropy in classification problems. The second term <span class="math inline">\(\omega(f_i)\)</span> is a regularized term to control the model’s complexity to avoid overfitting.</p>
<p>When additively training the model, XGBoost used a second-order Taylor expansion to approximate the objective function instead of using the negative gradient.</p>
<p>After derivation, the optimization goal at step k will be <span class="math display">\[\sum_{i=1}^{n}[g_if_k(x_i) + \frac{1}{2}h_{i}f_k^2(x_i)] + \omega(f_k)\]</span></p>
<p>where <span class="math inline">\(g_i\)</span> and <span class="math inline">\(h_i\)</span> denote the first-order and second-order derivative of the loss function to the current model’s prediction. i.e.&nbsp;<span class="math inline">\(g_i = \partial_{\hat{y_i}^{k-1}}l(y_i, \hat{y_i}^{k-1})\)</span> and <span class="math inline">\(h_i = \partial^2_{\hat{y_i}{k-1}}l(y_i, \hat{y_i}^{k-1})\)</span></p>
<p>We find that the objective function for each tree depends only on <span class="math inline">\(g_i\)</span> and <span class="math inline">\(h_i\)</span>, derivatives of the loss function. Therefore, XGBoost can be widely used in many scenarios, including regression, classification, and ranking problems, as long as XGBoost is given a loss function that is second-order differentiable. You can even customize your loss function in XGBoost!</p>
<p><strong>Approximate Split Finding</strong></p>
<p>We first look at a basic greedy approach for finding best split point.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="img/Exact_greedy_algorithm.png" width="500" height="300"></p>
</div>
</div>
<p>In the above Exact Greedy Algorithm, we need to traverse every possible value of every feature to find the best split point. The score measures the reduction of loss function before and after the split. However, the method is inefficient when dealing with large datasets.</p>
<p>Instead, XGBoost used an approximated approach to find split points efficiently.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="img/approximate_algorithm.webp" width="500" height="300"></p>
</div>
</div>
<p>In the approximate framework, we first select some candidate splitting points according to percentiles of the feature distribution based on some criteria. For instance, a sorted feature column contains 10 values [1,2,2,2,2,4,5,7,9,20]. A 0.6 quantile corresponds to 4.</p>
<p><strong>Weighted Quantile Sketch</strong></p>
<p>How do we find these candidate split points? We cannot assign equal weights to every observation of the feature, as larger values may have a more significant impact on the loss function. Therefore, we need to calculate a weight for each feature value to make candidates distribute evenly on the data.</p>
<p>For each observation, XGBoost used its second-order derivative <span class="math inline">\(h_i\)</span> as weight. Formally, let multi-set <span class="math inline">\(D_k = {(x_{1k},h_1), (x_{2k}, h_2)&lt;e2&gt;&lt;80&gt;&lt;a6&gt;(x_{nk}, h_{n})}\)</span> denote k-th feature value and its corresponding second-order gradient, the rank function is <span class="math display">\[r_k(z) = \frac{1}{\sum_{(x,h) \in D_k}h}\sum_{(x,h) \in D_k, x &lt; z}h\]</span>.</p>
<p>For example, given</p>
<table class="table">
<thead>
<tr class="header">
<th>feature value</th>
<th>1</th>
<th>4</th>
<th>6</th>
<th>10</th>
<th>12</th>
<th>20</th>
<th>30</th>
<th>44</th>
<th>59</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math display">\[h_i\]</span></td>
<td>0.1</td>
<td>0.1</td>
<td>0.1</td>
<td>0.1</td>
<td>0.1</td>
<td>0.1</td>
<td>0.4</td>
<td>0.2</td>
<td>0.6</td>
</tr>
</tbody>
</table>
<p>30 corresponds to <span class="math inline">\(\frac{1}{3}\)</span> percentile, and 59 corresponds to <span class="math inline">\(\frac{2}{3}\)</span> percentile.</p>
<p><strong>Other techniques in XGBoost to improve efficiency</strong></p>
<ul>
<li><p>Each column (feature) of the dataset is pre-sorted and stored in memory as a column block. Each block contains the sorted feature column and each observation’s corresponding label value. Recall that when finding the best split point in a decision tree, samples with the feature value less than the split value go to the left subtree, and samples with the feature value larger than the split point go to the right subtree. Instead of sorting in every split in every tree, this pre-sorting step is done only once. Then the efficiently sorted columns will be reused many times in building every single tree.</p></li>
<li><p>XGBoost supports parallel computing during the process of finding the best split point in building a single tree. Then the information gain calculation for each feature can be done in parallel. Moreover, You can tune the parameter nthread to control the number of cores used in training the XGBoost model.</p></li>
<li><p>XGBoost supports column subsampling similar to a random forest.</p></li>
</ul>
</section>
<section id="application-in-r-credit-card-fraud-detection" class="level2">
<h2 class="anchored" data-anchor-id="application-in-r-credit-card-fraud-detection">Application in R: Credit Card Fraud Detection</h2>
<p>Having grasped the mathematical concepts behind it, we can now proceed to the most exhilarating segment: applying this model in R</p>
<p><strong>Dataset Introduction</strong></p>
<p>This vignette is conducted on a simulated <a href="https://www.kaggle.com/datasets/dhanushnarayananr/credit-card-fraud/data">“Credit Card Fraud”</a> dataset obtained on Kaggle. This dataset presents a binary classification problem, classifying transactions as either fraudulent or legitimate. With 8 variables and a total of 1,000,000 observations, only 8.74% (87,403) are marked as fraudulent, highlighting a significant class imbalance.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 13%">
<col style="width: 21%">
<col style="width: 21%">
<col style="width: 11%">
<col style="width: 7%">
<col style="width: 11%">
<col style="width: 9%">
<col style="width: 4%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">distance_from_home</th>
<th style="text-align: right;">distance_from_last_transaction</th>
<th style="text-align: right;">ratio_to_median_purchase_price</th>
<th style="text-align: right;">repeat_retailer</th>
<th style="text-align: right;">used_chip</th>
<th style="text-align: right;">used_pin_number</th>
<th style="text-align: right;">online_order</th>
<th style="text-align: right;">fraud</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">57.877857</td>
<td style="text-align: right;">0.3111400</td>
<td style="text-align: right;">1.9459400</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">10.829943</td>
<td style="text-align: right;">0.1755915</td>
<td style="text-align: right;">1.2942188</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5.091080</td>
<td style="text-align: right;">0.8051526</td>
<td style="text-align: right;">0.4277146</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">2.247564</td>
<td style="text-align: right;">5.6000435</td>
<td style="text-align: right;">0.3626626</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">44.190936</td>
<td style="text-align: right;">0.5664863</td>
<td style="text-align: right;">2.2227673</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">5.586408</td>
<td style="text-align: right;">13.2610733</td>
<td style="text-align: right;">0.0647685</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The variable explanations are as follows:</p>
<table class="table">
<colgroup>
<col style="width: 39%">
<col style="width: 42%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Variable Name</th>
<th style="text-align: center;">Feature Explanation</th>
<th style="text-align: center;">Type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">distance_from_home</td>
<td style="text-align: center;">The distance from home where the transaction happened</td>
<td style="text-align: center;">Continuous</td>
</tr>
<tr class="even">
<td style="text-align: center;">distance_from_last_transaction</td>
<td style="text-align: center;">The distance from last transaction happened</td>
<td style="text-align: center;">Continuous</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ratio_to_median_purchase_price</td>
<td style="text-align: center;">Ratio of purchased price transaction to median purchase price</td>
<td style="text-align: center;">Continuous</td>
</tr>
<tr class="even">
<td style="text-align: center;">repeat_retailer</td>
<td style="text-align: center;">Is the transaction happened from same retailer</td>
<td style="text-align: center;">Discrete</td>
</tr>
<tr class="odd">
<td style="text-align: center;">used_chip</td>
<td style="text-align: center;">Is the transaction through credit card chip</td>
<td style="text-align: center;">Discrete</td>
</tr>
<tr class="even">
<td style="text-align: center;">used_pin_number</td>
<td style="text-align: center;">Is the transaction happened by using PIN number</td>
<td style="text-align: center;">Discrete</td>
</tr>
<tr class="odd">
<td style="text-align: center;">online_order</td>
<td style="text-align: center;">Is the transaction an online order</td>
<td style="text-align: center;">Discrete</td>
</tr>
<tr class="even">
<td style="text-align: center;">fraud</td>
<td style="text-align: center;">Is the transaction fraudulent</td>
<td style="text-align: center;">Discrete</td>
</tr>
</tbody>
</table>
<p><strong>Exploratory Data Analysis</strong></p>
<p>Building on the introduction, we’ve established a basic understanding of the dataset, including the meaning of each variable. But before progressing to model training, it’s important to deepen our familiarity with the data through comprehensive Exploratory Data Analysis.</p>
<p>First, we want to check if there is missing values in the dataset</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check missing values</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>data <span class="sc">%&gt;%</span> <span class="fu">is.na</span>() <span class="sc">%&gt;%</span> <span class="fu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
<p>Through the code above, we know that this dataset contains no missing value, therefore there is no imputation needed. Then, we can use the following chunk to check the distribution of the variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot variable distribution</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (col <span class="cf">in</span> <span class="fu">colnames</span>(data)) {</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  density_values <span class="ot">&lt;-</span> <span class="fu">density</span>(data[[col]])</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(density_values, <span class="at">main =</span> col, <span class="at">col =</span> <span class="st">"skyblue"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="vignette_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can observe from the density curve graph of each variable that except for the first three, the other 5 variables including our response variable ‘fraud’ are binary. But the first three variables are greatly skewed. After that, we want to see if correlation exists between the variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># correlation plot</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlation</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>data <span class="sc">%&gt;%</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>(<span class="at">use =</span> <span class="st">'everything'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">corrplot</span>(<span class="at">type =</span> <span class="st">'lower'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="vignette_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>From the correlation plot, the numerical variable ‘ratio_to_median’ has a positive correlation with respect to ‘fraud’, and then are ‘distance_from_home’ and ‘online_order’. Other than that, ‘used_pin_number’ has negatively correlated with ‘fraud’. Lastly, we want to specifically analyze the distribution of the response variable, which is our most interested variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># response distribution</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>plot.fraud <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">ifelse</span>(data<span class="sc">$</span>fraud <span class="sc">==</span> <span class="dv">0</span>, <span class="st">'Safe'</span>, <span class="st">'Fraud'</span>))) <span class="sc">+</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="st">'cyan'</span>,<span class="st">'cornflowerblue'</span>)) <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="st">"Distribution of Fraud in the Dataset"</span>, <span class="at">x=</span><span class="st">"Fraud Class"</span>, <span class="at">y=</span><span class="st">"Count"</span>) <span class="sc">+</span> </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">after_stat</span>(count)), <span class="at">stat =</span> <span class="st">"count"</span>, <span class="at">vjust =</span> <span class="fl">1.5</span>, <span class="at">colour =</span> <span class="st">"white"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>table.fraud <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">ifelse</span>(data<span class="sc">$</span>fraud <span class="sc">==</span> <span class="dv">0</span>, <span class="st">'Safe'</span>, <span class="st">'Fraud'</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="st">'8.74%'</span>,<span class="st">'91.26%'</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">tableGrob</span>()</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(<span class="fu">arrangeGrob</span>(plot.fraud, table.fraud, <span class="at">ncol=</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="vignette_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This graph represents the distribution of ‘fraud’. Around 91% of the transactions are not fraud and 9% are fraud, which reflects a imbalance in the data. This imbalance suggests adapting performance metrics like AUC-ROC, f1 score as evaluation metrics instead of “accurary” to assess the ML model.</p>
<p><strong>Data Preprocessing</strong></p>
<p>Prior to model fitting, it’s essential to assess the scale of the variables, as disparities in scale can adversely affect model performance. In our dataset, variables like distance and ratio are not on the same scale, necessitating their transformation to a unified scale. Additionally, other preprocessing steps are undertaken, including systematic trimming of outliers and renaming selected variables for enhanced clarity and succinctness.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>trim <span class="ot">&lt;-</span> <span class="cf">function</span>(x, .at){</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  x[<span class="fu">abs</span>(x) <span class="sc">&gt;</span> .at] <span class="ot">&lt;-</span> <span class="fu">sign</span>(x[<span class="fu">abs</span>(x) <span class="sc">&gt;</span> .at])<span class="sc">*</span>.at</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(x)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># rename and scale: since some variable are on distance scale/some are ratio</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">dist_home =</span> distance_from_home,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">dist_last_transact =</span> distance_from_last_transaction,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">ratio_to_med_price =</span> ratio_to_median_purchase_price) <span class="sc">%&gt;%</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">c</span>(dist_home, dist_last_transact, ratio_to_med_price), </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span> <span class="fu">trim</span>(<span class="fu">scale</span>((.x))[, <span class="dv">1</span>], <span class="at">.at =</span> <span class="dv">3</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Fraud Detection with XGBoost in R</strong></p>
<ul>
<li>Data Preparation</li>
</ul>
<p>Once the data is cleaned, additional preparations are required before we proceed with model fitting. Similar to other models, the first step involves splitting the data into subsets. A notable feature of the XGBoost function is the ‘watchlist’ parameter, which allows the inclusion of a validation dataset. This feature displays the log-loss for each boosting iteration on both the training and validation sets, aiding in the prevention of overfitting. Therefore, we partition our dataset into training (60%), validation (20%), and testing (20%) subsets. We apply stratification on the <e2>&lt;80&gt;&lt;98&gt;fraud<e2>&lt;80&gt;&lt;99&gt; variable to ensure each subset is representative of the original dataset’s composition. Following this, the split data must be converted to xgb.DMatrix format, an efficient data structure that is specifically required by the XGBoost model.</e2></e2></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#set seed for reproducibility</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">197</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">#split training/validation/testing</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>data.split <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">initial_split</span>(<span class="at">prop =</span> <span class="fl">0.6</span>, <span class="at">strata =</span> fraud)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>test.split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(<span class="fu">testing</span>(data.split), <span class="at">prop =</span> <span class="fl">0.5</span>, <span class="at">strata =</span> fraud)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>data.val <span class="ot">&lt;-</span> <span class="fu">training</span>(test.split)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>data.test <span class="ot">&lt;-</span> <span class="fu">testing</span>(test.split)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">#define predictor and response variables in training set</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: XGBoost only use matrix data</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>train.x <span class="ot">&lt;-</span>  <span class="fu">data.matrix</span>(<span class="fu">training</span>(data.split) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>fraud))</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>train.y <span class="ot">&lt;-</span>  <span class="fu">training</span>(data.split) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(fraud)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">#define predictor and response variables in validation set</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>val.x <span class="ot">&lt;-</span>  <span class="fu">data.matrix</span>(data.val <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>fraud))</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>val.y <span class="ot">&lt;-</span>  data.val <span class="sc">%&gt;%</span> <span class="fu">pull</span>(fraud)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co">#define predictor and response variables in testing set</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>test.x <span class="ot">&lt;-</span>  <span class="fu">data.matrix</span>(data.test <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>fraud))</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>test.y <span class="ot">&lt;-</span>  data.test <span class="sc">%&gt;%</span> <span class="fu">pull</span>(fraud)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="co">#define xgb.DMatirx: This is a specialized data structure that xgboost uses for efficiency</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>xgb.train <span class="ot">&lt;-</span>  <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> train.x, <span class="at">label =</span> train.y)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>xgb.val <span class="ot">&lt;-</span>  <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> val.x, <span class="at">label =</span> val.y)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>xgb.test <span class="ot">&lt;-</span>  <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> test.x, <span class="at">label =</span> test.y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Model Fitting</strong></p>
<p>Finally, we are at the model fitting part! Let’s first talk about the parameters:</p>
<ul>
<li><p><strong>objective:</strong> The goal of the model. In this case, we use ‘binary:logistic’ to predict the probability of having a fraud based on the predictor variables</p></li>
<li><p><strong>eta:</strong> The learning speed and we used the default value of 0.3</p></li>
<li><p><strong>data:</strong> Training data in DMatrix structure</p></li>
<li><p><strong>max.depth:</strong> The size of each tree and a rule of thumb is to use 2 or 3 to prevent overfitting</p></li>
<li><p><strong>watchlist:</strong> Track model performance on training and validation data during the training process to prevent overfitting</p></li>
<li><p><strong>nrounds:</strong> Number of boosting rounds</p></li>
<li><p><strong>early_stopping_rounds:</strong> Stop the training process if the model’s accuracy on validation set hasn’t improved for the specified number of rounds</p></li>
</ul>
<p>As mentioned earlier, we utilize a watchlist along with a validation set to determine the optimal number of boosting rounds (nrounds). During training, we monitor the model’s performance on both the training and validation datasets. The watchlist is often used in conjunction with the early_stopping_rounds parameter, which helps in identifying the point of overfitting and the appropriate time to halt the training process. The training ceases when there is no improvement in the model’s performance on the validation set for a consecutively specified number of rounds. At this point, the early_stopping_rounds feature intervenes and shows the optimal number of boosting iterations.</p>
<p><strong>NOTE:</strong> The output of the following code chunk is long, but we have chosen to keep it in its entirety. This decision is made to comprehensively illustrate the entire process of boosting iterations, and to clearly demonstrate the functionality of both the watchlist and early_stopping_rounds.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define the watchlist and other parameters</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>watchlist <span class="ot">=</span> <span class="fu">list</span>(<span class="at">train=</span>xgb.train, <span class="at">validation=</span>xgb.val)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">objective =</span> <span class="st">"binary:logistic"</span>, <span class="co"># loss function for binary classification problem</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">eta =</span> <span class="fl">0.3</span> <span class="co"># learning rate</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co"># fit XGBoost model: display training and testing data at each round</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span>  <span class="fu">xgb.train</span>(<span class="at">params =</span> params, </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> xgb.train, <span class="co"># Training data</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>                    <span class="at">max.depth =</span> <span class="dv">3</span>, <span class="co"># Size of each individual tree</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>                    <span class="at">watchlist=</span>watchlist, <span class="co"># Track model performance on train and validation set</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>                    <span class="at">nrounds =</span> <span class="dv">500</span>, <span class="co"># Number of boosting iterations</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>                    <span class="at">early_stopping_rounds =</span> <span class="dv">50</span>) <span class="co"># Number of iterations we will wait for the next decrease</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] train-logloss:0.451127  validation-logloss:0.451234 
Multiple eval metrics are present. Will use validation_logloss for early stopping.
Will train until validation_logloss hasn't improved in 50 rounds.

[2] train-logloss:0.315480  validation-logloss:0.315400 
[3] train-logloss:0.230386  validation-logloss:0.230380 
[4] train-logloss:0.172470  validation-logloss:0.172339 
[5] train-logloss:0.132665  validation-logloss:0.132591 
[6] train-logloss:0.103900  validation-logloss:0.103731 
[7] train-logloss:0.083184  validation-logloss:0.083053 
[8] train-logloss:0.068000  validation-logloss:0.067906 
[9] train-logloss:0.056529  validation-logloss:0.056380 
[10]    train-logloss:0.047899  validation-logloss:0.047716 
[11]    train-logloss:0.041405  validation-logloss:0.041280 
[12]    train-logloss:0.035617  validation-logloss:0.035361 
[13]    train-logloss:0.031879  validation-logloss:0.031617 
[14]    train-logloss:0.029015  validation-logloss:0.028713 
[15]    train-logloss:0.025746  validation-logloss:0.025646 
[16]    train-logloss:0.022735  validation-logloss:0.022630 
[17]    train-logloss:0.020837  validation-logloss:0.020740 
[18]    train-logloss:0.018697  validation-logloss:0.018630 
[19]    train-logloss:0.017351  validation-logloss:0.017269 
[20]    train-logloss:0.015829  validation-logloss:0.015803 
[21]    train-logloss:0.014291  validation-logloss:0.014280 
[22]    train-logloss:0.013309  validation-logloss:0.013313 
[23]    train-logloss:0.012142  validation-logloss:0.012122 
[24]    train-logloss:0.011534  validation-logloss:0.011516 
[25]    train-logloss:0.010776  validation-logloss:0.010751 
[26]    train-logloss:0.009838  validation-logloss:0.009849 
[27]    train-logloss:0.009218  validation-logloss:0.009230 
[28]    train-logloss:0.008827  validation-logloss:0.008860 
[29]    train-logloss:0.008284  validation-logloss:0.008290 
[30]    train-logloss:0.007880  validation-logloss:0.007913 
[31]    train-logloss:0.007359  validation-logloss:0.007387 
[32]    train-logloss:0.006815  validation-logloss:0.006847 
[33]    train-logloss:0.006499  validation-logloss:0.006555 
[34]    train-logloss:0.006125  validation-logloss:0.006183 
[35]    train-logloss:0.005733  validation-logloss:0.005795 
[36]    train-logloss:0.005460  validation-logloss:0.005519 
[37]    train-logloss:0.005100  validation-logloss:0.005168 
[38]    train-logloss:0.004777  validation-logloss:0.004857 
[39]    train-logloss:0.004418  validation-logloss:0.004494 
[40]    train-logloss:0.004262  validation-logloss:0.004343 
[41]    train-logloss:0.004010  validation-logloss:0.004088 
[42]    train-logloss:0.003817  validation-logloss:0.003903 
[43]    train-logloss:0.003683  validation-logloss:0.003777 
[44]    train-logloss:0.003497  validation-logloss:0.003580 
[45]    train-logloss:0.003383  validation-logloss:0.003470 
[46]    train-logloss:0.003141  validation-logloss:0.003228 
[47]    train-logloss:0.003010  validation-logloss:0.003111 
[48]    train-logloss:0.002836  validation-logloss:0.002926 
[49]    train-logloss:0.002677  validation-logloss:0.002775 
[50]    train-logloss:0.002568  validation-logloss:0.002661 
[51]    train-logloss:0.002416  validation-logloss:0.002515 
[52]    train-logloss:0.002235  validation-logloss:0.002337 
[53]    train-logloss:0.002161  validation-logloss:0.002264 
[54]    train-logloss:0.002057  validation-logloss:0.002166 
[55]    train-logloss:0.001896  validation-logloss:0.002013 
[56]    train-logloss:0.001812  validation-logloss:0.001927 
[57]    train-logloss:0.001728  validation-logloss:0.001846 
[58]    train-logloss:0.001664  validation-logloss:0.001778 
[59]    train-logloss:0.001565  validation-logloss:0.001682 
[60]    train-logloss:0.001492  validation-logloss:0.001610 
[61]    train-logloss:0.001448  validation-logloss:0.001568 
[62]    train-logloss:0.001392  validation-logloss:0.001514 
[63]    train-logloss:0.001326  validation-logloss:0.001444 
[64]    train-logloss:0.001247  validation-logloss:0.001365 
[65]    train-logloss:0.001195  validation-logloss:0.001316 
[66]    train-logloss:0.001156  validation-logloss:0.001277 
[67]    train-logloss:0.001101  validation-logloss:0.001226 
[68]    train-logloss:0.001058  validation-logloss:0.001187 
[69]    train-logloss:0.001015  validation-logloss:0.001143 
[70]    train-logloss:0.000985  validation-logloss:0.001115 
[71]    train-logloss:0.000943  validation-logloss:0.001079 
[72]    train-logloss:0.000909  validation-logloss:0.001041 
[73]    train-logloss:0.000860  validation-logloss:0.000993 
[74]    train-logloss:0.000827  validation-logloss:0.000964 
[75]    train-logloss:0.000799  validation-logloss:0.000935 
[76]    train-logloss:0.000775  validation-logloss:0.000912 
[77]    train-logloss:0.000744  validation-logloss:0.000886 
[78]    train-logloss:0.000712  validation-logloss:0.000852 
[79]    train-logloss:0.000683  validation-logloss:0.000826 
[80]    train-logloss:0.000622  validation-logloss:0.000769 
[81]    train-logloss:0.000607  validation-logloss:0.000755 
[82]    train-logloss:0.000589  validation-logloss:0.000736 
[83]    train-logloss:0.000567  validation-logloss:0.000714 
[84]    train-logloss:0.000550  validation-logloss:0.000698 
[85]    train-logloss:0.000532  validation-logloss:0.000679 
[86]    train-logloss:0.000513  validation-logloss:0.000661 
[87]    train-logloss:0.000498  validation-logloss:0.000647 
[88]    train-logloss:0.000470  validation-logloss:0.000622 
[89]    train-logloss:0.000454  validation-logloss:0.000608 
[90]    train-logloss:0.000433  validation-logloss:0.000589 
[91]    train-logloss:0.000420  validation-logloss:0.000578 
[92]    train-logloss:0.000401  validation-logloss:0.000563 
[93]    train-logloss:0.000387  validation-logloss:0.000551 
[94]    train-logloss:0.000371  validation-logloss:0.000534 
[95]    train-logloss:0.000357  validation-logloss:0.000526 
[96]    train-logloss:0.000349  validation-logloss:0.000519 
[97]    train-logloss:0.000338  validation-logloss:0.000511 
[98]    train-logloss:0.000327  validation-logloss:0.000496 
[99]    train-logloss:0.000312  validation-logloss:0.000481 
[100]   train-logloss:0.000302  validation-logloss:0.000472 
[101]   train-logloss:0.000292  validation-logloss:0.000462 
[102]   train-logloss:0.000283  validation-logloss:0.000454 
[103]   train-logloss:0.000275  validation-logloss:0.000449 
[104]   train-logloss:0.000258  validation-logloss:0.000431 
[105]   train-logloss:0.000250  validation-logloss:0.000423 
[106]   train-logloss:0.000242  validation-logloss:0.000420 
[107]   train-logloss:0.000233  validation-logloss:0.000407 
[108]   train-logloss:0.000224  validation-logloss:0.000400 
[109]   train-logloss:0.000218  validation-logloss:0.000394 
[110]   train-logloss:0.000211  validation-logloss:0.000389 
[111]   train-logloss:0.000194  validation-logloss:0.000374 
[112]   train-logloss:0.000187  validation-logloss:0.000368 
[113]   train-logloss:0.000182  validation-logloss:0.000362 
[114]   train-logloss:0.000177  validation-logloss:0.000359 
[115]   train-logloss:0.000171  validation-logloss:0.000356 
[116]   train-logloss:0.000166  validation-logloss:0.000351 
[117]   train-logloss:0.000160  validation-logloss:0.000345 
[118]   train-logloss:0.000155  validation-logloss:0.000344 
[119]   train-logloss:0.000152  validation-logloss:0.000341 
[120]   train-logloss:0.000147  validation-logloss:0.000339 
[121]   train-logloss:0.000142  validation-logloss:0.000336 
[122]   train-logloss:0.000138  validation-logloss:0.000332 
[123]   train-logloss:0.000133  validation-logloss:0.000328 
[124]   train-logloss:0.000130  validation-logloss:0.000327 
[125]   train-logloss:0.000126  validation-logloss:0.000323 
[126]   train-logloss:0.000123  validation-logloss:0.000323 
[127]   train-logloss:0.000119  validation-logloss:0.000321 
[128]   train-logloss:0.000116  validation-logloss:0.000318 
[129]   train-logloss:0.000112  validation-logloss:0.000314 
[130]   train-logloss:0.000109  validation-logloss:0.000312 
[131]   train-logloss:0.000106  validation-logloss:0.000308 
[132]   train-logloss:0.000103  validation-logloss:0.000309 
[133]   train-logloss:0.000101  validation-logloss:0.000306 
[134]   train-logloss:0.000098  validation-logloss:0.000303 
[135]   train-logloss:0.000095  validation-logloss:0.000304 
[136]   train-logloss:0.000093  validation-logloss:0.000301 
[137]   train-logloss:0.000091  validation-logloss:0.000299 
[138]   train-logloss:0.000088  validation-logloss:0.000299 
[139]   train-logloss:0.000086  validation-logloss:0.000299 
[140]   train-logloss:0.000084  validation-logloss:0.000300 
[141]   train-logloss:0.000082  validation-logloss:0.000297 
[142]   train-logloss:0.000080  validation-logloss:0.000296 
[143]   train-logloss:0.000078  validation-logloss:0.000296 
[144]   train-logloss:0.000076  validation-logloss:0.000294 
[145]   train-logloss:0.000074  validation-logloss:0.000296 
[146]   train-logloss:0.000068  validation-logloss:0.000288 
[147]   train-logloss:0.000067  validation-logloss:0.000284 
[148]   train-logloss:0.000065  validation-logloss:0.000284 
[149]   train-logloss:0.000063  validation-logloss:0.000284 
[150]   train-logloss:0.000062  validation-logloss:0.000283 
[151]   train-logloss:0.000061  validation-logloss:0.000281 
[152]   train-logloss:0.000060  validation-logloss:0.000281 
[153]   train-logloss:0.000058  validation-logloss:0.000280 
[154]   train-logloss:0.000057  validation-logloss:0.000282 
[155]   train-logloss:0.000053  validation-logloss:0.000276 
[156]   train-logloss:0.000052  validation-logloss:0.000276 
[157]   train-logloss:0.000051  validation-logloss:0.000272 
[158]   train-logloss:0.000050  validation-logloss:0.000274 
[159]   train-logloss:0.000049  validation-logloss:0.000270 
[160]   train-logloss:0.000048  validation-logloss:0.000271 
[161]   train-logloss:0.000047  validation-logloss:0.000272 
[162]   train-logloss:0.000046  validation-logloss:0.000271 
[163]   train-logloss:0.000045  validation-logloss:0.000271 
[164]   train-logloss:0.000044  validation-logloss:0.000272 
[165]   train-logloss:0.000043  validation-logloss:0.000271 
[166]   train-logloss:0.000042  validation-logloss:0.000274 
[167]   train-logloss:0.000042  validation-logloss:0.000273 
[168]   train-logloss:0.000041  validation-logloss:0.000272 
[169]   train-logloss:0.000040  validation-logloss:0.000272 
[170]   train-logloss:0.000039  validation-logloss:0.000274 
[171]   train-logloss:0.000039  validation-logloss:0.000272 
[172]   train-logloss:0.000038  validation-logloss:0.000274 
[173]   train-logloss:0.000038  validation-logloss:0.000274 
[174]   train-logloss:0.000035  validation-logloss:0.000272 
[175]   train-logloss:0.000035  validation-logloss:0.000273 
[176]   train-logloss:0.000034  validation-logloss:0.000272 
[177]   train-logloss:0.000033  validation-logloss:0.000271 
[178]   train-logloss:0.000033  validation-logloss:0.000272 
[179]   train-logloss:0.000031  validation-logloss:0.000271 
[180]   train-logloss:0.000031  validation-logloss:0.000272 
[181]   train-logloss:0.000030  validation-logloss:0.000270 
[182]   train-logloss:0.000030  validation-logloss:0.000271 
[183]   train-logloss:0.000028  validation-logloss:0.000270 
[184]   train-logloss:0.000028  validation-logloss:0.000270 
[185]   train-logloss:0.000028  validation-logloss:0.000269 
[186]   train-logloss:0.000027  validation-logloss:0.000270 
[187]   train-logloss:0.000027  validation-logloss:0.000270 
[188]   train-logloss:0.000026  validation-logloss:0.000270 
[189]   train-logloss:0.000026  validation-logloss:0.000271 
[190]   train-logloss:0.000025  validation-logloss:0.000270 
[191]   train-logloss:0.000025  validation-logloss:0.000269 
[192]   train-logloss:0.000025  validation-logloss:0.000269 
[193]   train-logloss:0.000024  validation-logloss:0.000268 
[194]   train-logloss:0.000024  validation-logloss:0.000269 
[195]   train-logloss:0.000024  validation-logloss:0.000269 
[196]   train-logloss:0.000023  validation-logloss:0.000266 
[197]   train-logloss:0.000022  validation-logloss:0.000266 
[198]   train-logloss:0.000022  validation-logloss:0.000267 
[199]   train-logloss:0.000021  validation-logloss:0.000265 
[200]   train-logloss:0.000021  validation-logloss:0.000266 
[201]   train-logloss:0.000021  validation-logloss:0.000264 
[202]   train-logloss:0.000020  validation-logloss:0.000265 
[203]   train-logloss:0.000020  validation-logloss:0.000265 
[204]   train-logloss:0.000020  validation-logloss:0.000262 
[205]   train-logloss:0.000019  validation-logloss:0.000263 
[206]   train-logloss:0.000019  validation-logloss:0.000262 
[207]   train-logloss:0.000019  validation-logloss:0.000263 
[208]   train-logloss:0.000019  validation-logloss:0.000263 
[209]   train-logloss:0.000018  validation-logloss:0.000263 
[210]   train-logloss:0.000018  validation-logloss:0.000264 
[211]   train-logloss:0.000018  validation-logloss:0.000263 
[212]   train-logloss:0.000018  validation-logloss:0.000264 
[213]   train-logloss:0.000017  validation-logloss:0.000264 
[214]   train-logloss:0.000017  validation-logloss:0.000262 
[215]   train-logloss:0.000017  validation-logloss:0.000262 
[216]   train-logloss:0.000017  validation-logloss:0.000261 
[217]   train-logloss:0.000016  validation-logloss:0.000262 
[218]   train-logloss:0.000016  validation-logloss:0.000262 
[219]   train-logloss:0.000016  validation-logloss:0.000263 
[220]   train-logloss:0.000016  validation-logloss:0.000263 
[221]   train-logloss:0.000016  validation-logloss:0.000264 
[222]   train-logloss:0.000016  validation-logloss:0.000265 
[223]   train-logloss:0.000015  validation-logloss:0.000264 
[224]   train-logloss:0.000015  validation-logloss:0.000264 
[225]   train-logloss:0.000015  validation-logloss:0.000265 
[226]   train-logloss:0.000015  validation-logloss:0.000264 
[227]   train-logloss:0.000015  validation-logloss:0.000264 
[228]   train-logloss:0.000015  validation-logloss:0.000264 
[229]   train-logloss:0.000015  validation-logloss:0.000265 
[230]   train-logloss:0.000014  validation-logloss:0.000265 
[231]   train-logloss:0.000014  validation-logloss:0.000265 
[232]   train-logloss:0.000014  validation-logloss:0.000266 
[233]   train-logloss:0.000014  validation-logloss:0.000265 
[234]   train-logloss:0.000014  validation-logloss:0.000265 
[235]   train-logloss:0.000013  validation-logloss:0.000264 
[236]   train-logloss:0.000013  validation-logloss:0.000265 
[237]   train-logloss:0.000013  validation-logloss:0.000265 
[238]   train-logloss:0.000013  validation-logloss:0.000266 
[239]   train-logloss:0.000013  validation-logloss:0.000266 
[240]   train-logloss:0.000013  validation-logloss:0.000266 
[241]   train-logloss:0.000013  validation-logloss:0.000267 
[242]   train-logloss:0.000013  validation-logloss:0.000266 
[243]   train-logloss:0.000012  validation-logloss:0.000267 
[244]   train-logloss:0.000012  validation-logloss:0.000266 
[245]   train-logloss:0.000012  validation-logloss:0.000267 
[246]   train-logloss:0.000012  validation-logloss:0.000267 
[247]   train-logloss:0.000012  validation-logloss:0.000267 
[248]   train-logloss:0.000012  validation-logloss:0.000268 
[249]   train-logloss:0.000012  validation-logloss:0.000269 
[250]   train-logloss:0.000012  validation-logloss:0.000268 
[251]   train-logloss:0.000012  validation-logloss:0.000269 
[252]   train-logloss:0.000012  validation-logloss:0.000269 
[253]   train-logloss:0.000011  validation-logloss:0.000269 
[254]   train-logloss:0.000011  validation-logloss:0.000269 
[255]   train-logloss:0.000011  validation-logloss:0.000269 
[256]   train-logloss:0.000011  validation-logloss:0.000269 
[257]   train-logloss:0.000011  validation-logloss:0.000270 
[258]   train-logloss:0.000011  validation-logloss:0.000269 
[259]   train-logloss:0.000011  validation-logloss:0.000270 
[260]   train-logloss:0.000011  validation-logloss:0.000269 
[261]   train-logloss:0.000011  validation-logloss:0.000269 
[262]   train-logloss:0.000011  validation-logloss:0.000270 
[263]   train-logloss:0.000011  validation-logloss:0.000270 
[264]   train-logloss:0.000011  validation-logloss:0.000271 
[265]   train-logloss:0.000011  validation-logloss:0.000271 
[266]   train-logloss:0.000010  validation-logloss:0.000271 
Stopping. Best iteration:
[216]   train-logloss:0.000017  validation-logloss:0.000261</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define final model</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># The argument verbose = 0 tells R not to display the training and testing error for each round.</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>final <span class="ot">&lt;-</span>  <span class="fu">xgboost</span>(<span class="at">params =</span> params, <span class="at">data =</span> xgb.train, <span class="at">max.depth =</span> <span class="dv">3</span>, <span class="at">nrounds =</span> <span class="dv">216</span>, <span class="at">verbose =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After the training model ceases operation, our first step is to examine the optimal number of boosting rounds it suggests. In our case, the model halted boosting at the 216th round, indicating an increase in log-loss on the validation set over the subsequent 50 rounds. This suggests that overfitting begins beyond this point. Consequently, we adjust the nrounds parameter to 216 for training our final model. For a more streamlined output, we set verbose = 0, instructing the model to train without reporting the log-loss at each iteration.</p>
<p><strong>Final Model Result and Analysis</strong></p>
<p>The final and crucial step involves assessing the model’s performance. We employ both the ROC-AUC plot and the confusion matrix for this evaluation. By analyzing the model’s performance on the testing dataset using these tools, we observed a remarkable AUC of 0.99988. This exceptionally high score underscores the model’s outstanding proficiency in classifying the testing data, as well as its robust generalizability to new, unseen datasets.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use model to make predictions on test data</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>pred.y <span class="ot">&lt;-</span> <span class="fu">predict</span>(final, test.x)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Label test data according to the predicted probability</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>pred.label <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(pred.y <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Confusion Matrix</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>confusion.matrix <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Predicted =</span> pred.label, <span class="at">Actual =</span> test.y)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co"># AUC-ROC</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>roc <span class="ot">&lt;-</span> <span class="fu">roc</span>(test.y, pred.label)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>auc <span class="ot">&lt;-</span> <span class="fu">auc</span>(roc)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggroc</span>(roc) <span class="sc">+</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"ROC Curve"</span>, <span class="at">x =</span> <span class="st">"False Positive Rate"</span>, <span class="at">y =</span> <span class="st">"True Positive Rate"</span>) <span class="sc">+</span> </span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">0.2</span>, <span class="at">y =</span> <span class="fl">0.8</span>, <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">"AUC ="</span>, <span class="fu">round</span>(auc, <span class="dv">5</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="vignette_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;"></th>
<th style="text-align: center;">Actual</th>
<th style="text-align: center;"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Predicted</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">0</td>
<td style="text-align: center;">182832</td>
<td style="text-align: center;">4</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">17164</td>
</tr>
</tbody>
</table>
<p>Additionally, it’s always a good idea to review the important features identified by the model after training an XGBoost. We can utilize the xgb.plot.importance function to visualize the most important features identified by XGBoost. This step not only aids in understanding the model’s decisions but also enhances our familiarity with this type of dataset, showcasing one of the advantages of tree-based methods: interpretability. The most critical among these is the ratio of the transaction purchase price to the median purchase price. This finding suggests that transactions with amounts significantly deviating from the median are more likely to be fraudulent. Also, the model indicates that online transactions are more likely to be fraudulent. Additionally, the distances from home to the current transaction<e2>&lt;80&gt;&lt;99&gt;s location another important features. Transactions occurring at locations far from home are also more likely to be identified as fraudulent.</e2></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature Importance</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>importance <span class="ot">&lt;-</span> <span class="fu">xgb.importance</span>(<span class="at">feature_names =</span> <span class="fu">colnames</span>(train.x), <span class="at">model =</span> final)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(importance) <span class="sc">%&gt;%</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Feature</th>
<th style="text-align: right;">Gain</th>
<th style="text-align: right;">Cover</th>
<th style="text-align: right;">Frequency</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">ratio_to_med_price</td>
<td style="text-align: right;">0.4031871</td>
<td style="text-align: right;">0.3009281</td>
<td style="text-align: right;">0.1916726</td>
</tr>
<tr class="even">
<td style="text-align: left;">online_order</td>
<td style="text-align: right;">0.2143521</td>
<td style="text-align: right;">0.0701108</td>
<td style="text-align: right;">0.1392678</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dist_home</td>
<td style="text-align: right;">0.1724054</td>
<td style="text-align: right;">0.2917286</td>
<td style="text-align: right;">0.2778177</td>
</tr>
<tr class="even">
<td style="text-align: left;">used_pin_number</td>
<td style="text-align: right;">0.0830197</td>
<td style="text-align: right;">0.0485586</td>
<td style="text-align: right;">0.1249103</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dist_last_transact</td>
<td style="text-align: right;">0.0706768</td>
<td style="text-align: right;">0.2458198</td>
<td style="text-align: right;">0.1557789</td>
</tr>
<tr class="even">
<td style="text-align: left;">used_chip</td>
<td style="text-align: right;">0.0563589</td>
<td style="text-align: right;">0.0428541</td>
<td style="text-align: right;">0.1105528</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot 3 most important features</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">xgb.plot.importance</span>(<span class="at">importance_matrix =</span> importance, <span class="at">top_n =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="vignette_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="check-list" class="level2">
<h2 class="anchored" data-anchor-id="check-list">Check List</h2>
<ol type="1">
<li>Conducted Exploratory Data Analysis to gain an understanding of the dataset</li>
<li>Divided the data into training, validation, and test sets, and converted it into the xgb.DMatrix structure</li>
<li>Utilized the xgb.train function with the watchlist and early_stopping_rounds parameters to determine the optimal number of boosting rounds</li>
<li>Trained the final model using the identified optimal number of rounds as nrounds</li>
<li>Evaluated the model’s performance using ROC-AUC plot and confusion matrix</li>
<li>Undertook additional analysis, such as visualizing the importance of features identified by the model</li>
<li>Now, it’s your turn to put these steps into practice!</li>
</ol>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>